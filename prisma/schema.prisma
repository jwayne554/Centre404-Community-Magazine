// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums (Task 3.1: Convert to Database Enums)
enum UserRole {
  ADMIN
  MODERATOR
  CONTRIBUTOR
}

enum SubmissionCategory {
  MY_NEWS
  SAYING_HELLO
  MY_SAY
}

enum SubmissionContentType {
  TEXT
  IMAGE
  AUDIO
  DRAWING
  MIXED
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

enum MagazineStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum MediaType {
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
}

// User model for authentication and authorization
model User {
  id                     String       @id @default(uuid())
  email                  String?      @unique
  name                   String
  password               String?      // Hashed password
  role                   UserRole     @default(CONTRIBUTOR)
  accessibilityPrefs     String       @default("{}")
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  
  // Relations
  submissions            Submission[]
  reviewedSubmissions    Submission[] @relation("ReviewedBy")
  publishedMagazines     Magazine[]   @relation("PublishedBy")
  auditLogs              AuditLog[]
}

// Submission model for user content
model Submission {
  id                String          @id @default(uuid())
  userId            String?
  user              User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  category          SubmissionCategory
  contentType       SubmissionContentType
  status            SubmissionStatus          @default(PENDING)

  // Content fields
  textContent       String?
  mediaUrl          String?         // Legacy field - kept for backward compatibility
  mediaThumbnailUrl String?         // Legacy field - kept for backward compatibility
  mediaMetadata     String          @default("{}")
  drawingData       String?         // Canvas drawing data
  accessibilityText String?         // Alt text or transcription
  userName          String?         // Optional display name for anonymous users

  // Timestamps
  submittedAt       DateTime        @default(now())
  reviewedAt        DateTime?
  updatedAt         DateTime        @updatedAt

  // Review fields
  reviewedById      String?
  reviewedBy        User?           @relation("ReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewNotes       String?

  // Relations
  magazineItems     MagazineItem[]
  media             Media[]         // New: Tracked media files (Task 1.5)

  // Existing indexes
  @@index([status, submittedAt])
  @@index([userId])
  @@index([category])

  // Performance indexes (Quick Win 4)
  @@index([status, category, submittedAt])  // Admin dashboard filtering
  @@index([category, status])                // Magazine viewer filtering
  @@index([reviewedById, reviewedAt])        // Reviewer productivity queries
  @@index([reviewedAt])                      // Time-based analytics
}

// Magazine model for published collections
model Magazine {
  id                String          @id @default(uuid())
  title             String
  description       String?
  version           String
  status            MagazineStatus  @default(DRAFT)
  theme             String          @default("{}")
  
  // Publishing info
  publishedAt       DateTime?
  publishedById     String?
  publishedBy       User?           @relation("PublishedBy", fields: [publishedById], references: [id], onDelete: SetNull)
  
  // Access control
  shareableSlug     String          @unique
  isPublic          Boolean         @default(false)
  viewCount         Int             @default(0)
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  items             MagazineItem[]

  // Existing indexes
  @@index([status, publishedAt])
  // Note: shareableSlug index removed (redundant with @unique)

  // Performance indexes (Quick Win 4)
  @@index([isPublic, status, publishedAt])  // Public magazine filtering
  @@index([viewCount])                       // Popular magazines
}

// Junction table for magazine items
model MagazineItem {
  id                String          @id @default(uuid())
  magazineId        String
  magazine          Magazine        @relation(fields: [magazineId], references: [id], onDelete: Cascade)
  submissionId      String
  submission        Submission      @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  displayOrder      Int
  customTitle       String?
  customDescription String?
  
  createdAt         DateTime        @default(now())

  @@unique([magazineId, submissionId])
  @@index([magazineId, displayOrder])
  @@index([submissionId])  // Reverse lookups (Quick Win 4)
}

// Audit log for tracking changes
model AuditLog {
  id                String          @id @default(uuid())
  userId            String?
  user              User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  action            String
  entityType        String
  entityId          String
  details           String
  ipAddress         String?
  userAgent         String?
  timestamp         DateTime        @default(now())

  @@index([entityType, entityId])
  @@index([userId, timestamp])
  @@index([action, timestamp])   // Action-based queries (Quick Win 4)
  @@index([timestamp])            // Time-based queries (Quick Win 4)
}

// Media storage tracking
model Media {
  id                String          @id @default(uuid())
  url               String
  thumbnailUrl      String?
  publicId          String?         // Cloudinary public ID
  type              MediaType
  size              Int             // File size in bytes
  mimeType          String
  metadata          String          @default("{}")
  uploadedAt        DateTime        @default(now())

  // Relations (Task 1.5 - Fix orphaned media)
  submissionId      String?
  submission        Submission?     @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([submissionId])           // Task 1.5: Track media ownership
}